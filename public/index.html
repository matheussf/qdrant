<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Semantic search application for finding relevant documents" />
  <title>Semantic Search</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div id="initialState" class="initial-state">
      <h1>Semantic Search</h1>
      <p class="subtitle">Find the documents that matter to you</p>
    </div>
    <div class="search-box">
      <input id="queryInput" type="text" placeholder="Enter your search query…" aria-label="Search query" />
      <button id="searchBtn">Search</button>
    </div>
    <div id="resultsSection" class="results-fade">
      <div id="suggestionsList" class="suggestions-list" role="listbox" aria-label="Search suggestions"></div>
      <div id="results" class="results-container" role="region" aria-label="Search results"></div>
      <div class="navigation-controls">
        <button class="pagination-button" id="prevPage" aria-label="Previous page">←</button>
        <button id="loadMoreBtn" class="load-more-button">Load More</button>
        <button class="pagination-button" id="nextPage" aria-label="Next page">→</button>
        <span class="pagination-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
      </div>
    </div>
  </div>

  <script>
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    document.addEventListener('DOMContentLoaded', () => {
      const initialState = document.getElementById('initialState');
      const resultsSection = document.getElementById('resultsSection');
      const queryInput = document.getElementById('queryInput');
      const searchBtn = document.getElementById('searchBtn');
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      const resultsDiv = document.getElementById('results');
      const suggestionsList = document.getElementById('suggestionsList');
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');
      const currentPageSpan = document.getElementById('currentPage');
      const totalPagesSpan = document.getElementById('totalPages');

      let currentQuery = '';
      let currentPage = 1;
      let totalPages = 1;
      let isLoading = false;
      let allResults = [];
      let totalResults = 0;
      let pageCache = {};
      const PAGE_SIZE = 5;
      let hasSearched = false;
      let lastPage = 1;

      // Hide results section initially
      resultsSection.classList.remove('show');

      // Hide controls by default
      prevPageBtn.style.display = 'none';
      nextPageBtn.style.display = 'none';
      document.querySelector('.pagination-info').style.display = 'none';
      loadMoreBtn.style.display = 'none';

      function renderResults(results) {
        resultsDiv.innerHTML = '';
        results.forEach((item, index) => {
          const card = document.createElement('div');
          card.className = 'result-item';
          card.style.animationDelay = `${index * 0.1}s`;
          card.innerHTML = `
            <h2>${item.title}</h2>
            <p>${item.snippet}</p>
          `;
          resultsDiv.appendChild(card);
        });
      }

      function showLoadingSkeletons() {
        const skeletons = Array(PAGE_SIZE).fill(null).map(() => {
          const skeleton = document.createElement('div');
          skeleton.className = 'result-item loading-more-skeleton';
          skeleton.innerHTML = `
            <div class="loading-skeleton" style="width: 70%; height: 24px;"></div>
            <div class="loading-skeleton" style="width: 90%;"></div>
            <div class="loading-skeleton" style="width: 80%;"></div>
          `;
          return skeleton;
        });
        skeletons.forEach(skeleton => resultsDiv.appendChild(skeleton));
      }

      function removeLoadingSkeletons() {
        const skeletons = resultsDiv.querySelectorAll('.loading-more-skeleton');
        skeletons.forEach(skeleton => skeleton.remove());
      }

      function showSuggestions(suggestions) {
        suggestionsList.innerHTML = suggestions
          .map((suggestion, index) => `
            <button class="suggestion-item" style="--index: ${index}" role="option">
              ${suggestion}
            </button>
          `)
          .join('');
        suggestionsList.classList.add('visible');
      }

      function hideSuggestions() {
        suggestionsList.classList.remove('visible');
      }

      function updateLoadMoreButton() {
        if (allResults.length === 0) {
          loadMoreBtn.classList.remove('visible');
          setTimeout(() => {
            loadMoreBtn.style.display = 'none';
          }, 300);
          return;
        }
        loadMoreBtn.style.display = 'block';
        requestAnimationFrame(() => {
          loadMoreBtn.classList.add('visible');
        });
      }

      function updatePagination() {
        totalPages = Math.ceil(totalResults / PAGE_SIZE);
        currentPageSpan.textContent = currentPage;
        totalPagesSpan.textContent = totalPages;
        if (totalPages > 1) {
          prevPageBtn.style.display = '';
          nextPageBtn.style.display = '';
          document.querySelector('.pagination-info').style.display = '';
        } else {
          prevPageBtn.style.display = 'none';
          nextPageBtn.style.display = 'none';
          document.querySelector('.pagination-info').style.display = 'none';
        }
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
      }

      async function fetchResults(query, page = 1) {
        const offset = (page - 1) * PAGE_SIZE;
        const res = await fetch(`/search?q=${encodeURIComponent(query)}&offset=${offset}`);
        const data = await res.json();
        const results = Array.isArray(data) ? data : data.results;
        const total = data.total || results.length * page;
        return { results, total };
      }

      async function performSearch(page = 1) {
        if (isLoading) return;
        isLoading = true;
        const query = queryInput.value;
        if (!query) {
          isLoading = false;
          return;
        }
        if (page === 1) {
          currentQuery = query;
          currentPage = 1;
          allResults = [];
          pageCache = {};
        }
        if (!hasSearched) {
          initialState.classList.add('hide');
          setTimeout(() => {
            resultsSection.classList.add('show');
          }, 400);
          hasSearched = true;
        }
        resultsDiv.innerHTML = '';
        showLoadingSkeletons();
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<span class="spinner" role="status" aria-label="Loading"></span>Searching...';
        try {
          let results, total;
          if (pageCache[page]) {
            ({ results, total } = pageCache[page]);
          } else {
            const fetched = await fetchResults(query, page);
            results = fetched.results;
            total = fetched.total;
            pageCache[page] = { results, total };
          }
          totalResults = total;
          allResults = results;
          if (results.length === 0) {
            loadMoreBtn.classList.remove('visible');
            setTimeout(() => {
              loadMoreBtn.style.display = 'none';
            }, 300);
            return;
          }
          removeLoadingSkeletons();
          renderResults(results);
          updatePagination();
          updateLoadMoreButton();
        } catch (error) {
          resultsDiv.innerHTML = `
            <div class="error-message" role="alert">
              <p>Error: ${error.message}</p>
              <button onclick="window.location.reload()">Try Again</button>
            </div>
          `;
        } finally {
          searchBtn.disabled = false;
          searchBtn.innerHTML = 'Search';
          isLoading = false;
        }
      }

      function loadMore() {
        if (isLoading) return;
        currentPage++;
        performSearch(currentPage);
      }

      function paginateWithPush(direction, renderFn) {
        resultsDiv.classList.remove('slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
        void resultsDiv.offsetWidth;
        if (direction === 'right') {
          resultsDiv.classList.add('slide-out-left');
        } else {
          resultsDiv.classList.add('slide-out-right');
        }
        setTimeout(() => {
          // Replace content and animate in
          renderFn();
          resultsDiv.classList.remove('slide-out-left', 'slide-out-right');
          void resultsDiv.offsetWidth;
          if (direction === 'right') {
            resultsDiv.classList.add('slide-in-right');
          } else {
            resultsDiv.classList.add('slide-in-left');
          }
          setTimeout(() => {
            resultsDiv.classList.remove('slide-in-right', 'slide-in-left');
          }, 350);
        }, 350);
      }

      searchBtn.addEventListener('click', () => performSearch(1));
      queryInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          performSearch(1);
        }
      });
      loadMoreBtn.addEventListener('click', () => {
        if (isLoading) return;
        currentPage++;
        loadMoreBtn.disabled = true;
        loadMoreBtn.innerHTML = '<span class="spinner" role="status" aria-label="Loading"></span>Loading...';
        resultsDiv.innerHTML = '';
        showLoadingSkeletons();
        if (pageCache[currentPage]) {
          setTimeout(() => {
            const skeletons = resultsDiv.querySelectorAll('.loading-more-skeleton');
            skeletons.forEach(s => s.classList.add('fade-out'));
            setTimeout(() => {
              renderResults(pageCache[currentPage].results);
              updatePagination();
              updateLoadMoreButton();
              loadMoreBtn.disabled = false;
              loadMoreBtn.innerHTML = 'Load More';
            }, 250);
          }, 600);
        } else {
          performSearch(currentPage).then(() => {
            const skeletons = resultsDiv.querySelectorAll('.loading-more-skeleton');
            skeletons.forEach(s => s.classList.add('fade-out'));
            setTimeout(() => {
              loadMoreBtn.disabled = false;
              loadMoreBtn.innerHTML = 'Load More';
            }, 250);
          });
        }
      });
      prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          if (pageCache[currentPage]) {
            paginateWithPush('left', () => {
              renderResults(pageCache[currentPage].results);
              updatePagination();
              updateLoadMoreButton();
            });
          } else {
            paginateWithPush('left', () => performSearch(currentPage));
          }
        }
      });
      nextPageBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          if (pageCache[currentPage]) {
            paginateWithPush('right', () => {
              renderResults(pageCache[currentPage].results);
              updatePagination();
              updateLoadMoreButton();
            });
          } else {
            paginateWithPush('right', () => performSearch(currentPage));
          }
        }
      });

      queryInput.addEventListener('input', debounce(async (e) => {
        const query = e.target.value;
        if (query.length >= 2) {
          try {
            const res = await fetch(`/suggestions?q=${encodeURIComponent(query)}`);
            const suggestions = await res.json();
            showSuggestions(suggestions);
          } catch (error) {
            hideSuggestions();
          }
        } else {
          hideSuggestions();
        }
      }, 300));

      document.addEventListener('keydown', (e) => {
        if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
          return;
        }

        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          queryInput.focus();
        }
      });
    });
  </script>
</body>
</html>

